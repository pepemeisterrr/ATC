<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ПсАТС - Автоматическая Телефонная Станция</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Основные стили */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Форма логина */
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
            width: 400px;
        }

        .login-box h1 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .login-box input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .login-box button {
            width: 100%;
            padding: 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .login-box button:hover {
            background: #2980b9;
        }

        .login-box .demo-info {
            margin-top: 20px;
            font-size: 14px;
            color: #7f8c8d;
        }

        /* Основной интерфейс */
        #main-content {
            display: none;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h2 {
            margin: 0;
        }

        #logout-btn {
            background: #e74c3c;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #logout-btn:hover {
            background: #c0392b;
        }

        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
            flex: 1;
        }

        #left-panel {
            flex: 1;
        }

        #right-panel {
            flex: 3;
        }

        .panel h3 {
            margin-top: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }

        th {
            background: #f4f4f4;
        }

        .overtime {
            color: red;
            font-weight: bold;
        }

        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
        }

        .btn-accept {
            background: #27ae60;
            color: white;
        }

        .btn-reject {
            background: #e74c3c;
            color: white;
        }

        .btn-transfer {
            background: #f39c12;
            color: white;
        }

        .btn-start {
            background: #3498db;
            color: white;
        }

        #map {
            height: 700px;
            width: 100%;
            margin-top: 20px;
        }

        /* Модальное окно для текущего вызова */
        #call-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            text-align: center;
        }

        .modal-content button {
            margin: 10px;
        }

        /* Прокручиваемый список вызовов */
        .call-list {
            max-height: 300px;
            overflow-y: auto;
        }

        /* Нижняя панель для логов */
        #logs-panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }

        /* Responsive для карты снизу на малых экранах */
        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }
        }
    </style>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=1163255e-bb23-48e7-aeb1-be5c1cc1be33&lang=ru_RU"></script>
</head>
<body>

    <!-- Форма логина -->
    <div id="login-container">
        <div class="login-box">
            <h1>ПсАТС - Автоматическая Телефонная Станция</h1>
            <p>Система для управления телефонными коммуникациями и маршрутизацией вызовов в пожарной охране.</p>
            <input type="text" id="username" placeholder="Логин" required>
            <input type="password" id="password" placeholder="Пароль" required>
            <button id="login-btn">Войти</button>
            <div class="demo-info">
                <p>Демо-доступы:</p>
                <p>Операторы: operator1 (Иван Иванов), operator2 (Петр Петров), operator3 (Сергей Сергеев) (пароль: 1234)</p>
                <p>Дежурный руководитель: supervisor1 (Алексей Алексеев) (пароль: 1234)</p>
            </div>
        </div>
    </div>

    <!-- Основной контент -->
    <div id="main-content">
        <header>
            <h2 id="user-info"></h2>
            <button id="logout-btn">Выйти</button>
        </header>
        <div class="container dashboard">
            <!-- Левая панель: Управление вызовами (для оператора) или Мониторинг (для супервизора) -->
            <div class="panel" id="left-panel"></div>
            <!-- Правая панель: Карта (для оператора) или Отчеты (для супервизора) -->
            <div class="panel" id="right-panel"></div>
        </div>
        <!-- Нижняя панель: Логи -->
        <div class="container" id="logs-panel" style="display: none;"></div>
    </div>

    <!-- Модальное окно для текущего вызова -->
    <div id="call-modal">
        <div class="modal-content">
            <h3>Текущий вызов</h3>
            <p id="call-info"></p>
            <button id="start-call-btn" class="btn btn-start">Начать разговор</button>
            <button id="transfer-call-btn" class="btn btn-transfer">Перевести вызов</button>
            <button id="false-call-btn" class="btn btn-reject">Ложный вызов</button>
            <button id="close-modal-btn" class="btn btn-reject">Закрыть</button>
        </div>
    </div>

    <script>
        // Bounding box Москвы (город)
        const moscowBBox = {
            latMin: 55.57,
            latMax: 55.91,
            lngMin: 37.35,
            lngMax: 37.84
        };

        // Тестовые аккаунты с вымышленными именами
        const users = {
            operator1: { role: 'operator', name: 'Иван Иванов', password: '1234', status: 'свободен' },
            operator2: { role: 'operator', name: 'Петр Петров', password: '1234', status: 'свободен' },
            operator3: { role: 'operator', name: 'Сергей Сергеев', password: '1234', status: 'свободен' },
            supervisor1: { role: 'supervisor', name: 'Алексей Алексеев', password: '1234' }
        };

        // Данные
        let calls = []; // Список вызовов
        let logs = []; // Логи
        let currentUser = null;
        let map = null;
        let markers = [];

        // Генерация случайного номера телефона
        function generatePhone() {
            return '+7 (' + Math.floor(Math.random() * 900 + 100) + ') ' + Math.floor(Math.random() * 900 + 100) + '-' + Math.floor(Math.random() * 90 + 10);
        }

        // Генерация случайного вызова (async для geocode)
        async function generateCall() {
            let lat = Math.random() * (moscowBBox.latMax - moscowBBox.latMin) + moscowBBox.latMin;
            let lng = Math.random() * (moscowBBox.lngMax - moscowBBox.lngMin) + moscowBBox.lngMin;
            let address = 'Неизвестный адрес'; // Fallback

            try {
                const res = await ymaps.geocode([lat, lng], { results: 1 });
                address = res.geoObjects.get(0).getAddressLine() || address;
            } catch (err) {
                console.error('Geocode error:', err);
            }

            const call = {
                id: calls.length + 1,
                phone: generatePhone(),
                address: address,
                lat: lat,
                lng: lng,
                time: Date.now(),
                status: 'ожидание',
                operator: null
            };
            calls.push(call);
            addLog(`Новый вызов #${call.id}: ${call.phone}, ${call.address}`);
            addMarker(call);
            updateUI();
        }

        // Добавление маркера на карту
        function addMarker(call) {
            const marker = new ymaps.Placemark([call.lat, call.lng], {
                hintContent: call.address,
                balloonContent: `Вызов #${call.id} от ${call.phone}, статус: ${call.status}`
            });
            map.geoObjects.add(marker);
            markers.push(marker);
            updateMarkerColor(marker, call.status);
        }

        // Обновление цвета маркера
        function updateMarkerColor(marker, status) {
            let color = 'blue';
            if (status === 'принят') color = 'green';
            if (status === 'ложный') color = 'red';
            if (status === 'в работе') color = 'orange';
            if (status === 'завершен') color = 'grey';
            marker.options.set('preset', `islands#${color}CircleDotIcon`);
        }

        // Логи
        function addLog(message) {
            logs.push({ time: new Date().toLocaleString(), message });
            updateUI();
        }

        // Логин
        document.getElementById('login-btn').addEventListener('click', () => {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const user = users[username];
            if (user && user.password === password) {
                currentUser = user;
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('user-info').innerText = `${user.name} (${user.role === 'operator' ? 'Оператор' : 'Дежурный Руководитель'})`;
                addLog(`Вход: ${user.name}`);
                updateUI();
                // Начать генерацию вызовов реже
                setInterval(() => generateCall(), Math.random() * 30000 + 10000); // 10-40 сек
            } else {
                alert('Неверный логин или пароль');
            }
        });

        // Выход
        document.getElementById('logout-btn').addEventListener('click', () => {
            currentUser = null;
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex';
            addLog('Выход');
        });

        // Обновление UI
        function updateUI() {
            if (!currentUser) return;

            const leftPanel = document.getElementById('left-panel');
            const rightPanel = document.getElementById('right-panel');
            const logsPanel = document.getElementById('logs-panel');
            logsPanel.style.display = 'block';

            leftPanel.innerHTML = '';
            rightPanel.innerHTML = '';
            logsPanel.innerHTML = '';

            if (currentUser.role === 'operator') {
                // Левая панель: Очередь вызовов (прокручиваемая) + статистика
                leftPanel.innerHTML = '<h3>Ожидающие вызовы</h3><div class="call-list"><table><tr><th>ID</th><th>Телефон</th><th>Адрес</th><th>Время ожидания</th><th>Действия</th></tr></table></div>';
                const table = leftPanel.querySelector('table');
                calls.filter(c => c.status === 'ожидание').forEach(call => {
                    const row = document.createElement('tr');
                    const waitTime = Math.floor((Date.now() - call.time) / 1000);
                    const overtime = waitTime > 30 ? 'overtime' : ''; // >30 сек - красный
                    row.innerHTML = `
                        <td>${call.id}</td>
                        <td>${call.phone}</td>
                        <td>${call.address}</td>
                        <td class="${overtime}">${waitTime} сек</td>
                        <td>
                            <button class="btn btn-accept" onclick="acceptCall(${call.id})">Принять</button>
                            <button class="btn btn-reject" onclick="rejectCall(${call.id})">Отклонить</button>
                        </td>
                    `;
                    table.appendChild(row);
                });

                // Статистика под списком
                const stats = calculateStats();
                leftPanel.innerHTML += `<h3>Статистика</h3>
                    <p>Вызовов сегодня: ${stats.total}</p>
                    <p>Ложные: ${stats.false}</p>
                    <p>В работе: ${stats.inWork}</p>
                    <p>Среднее время ответа: ${stats.avgTime} сек</p>`;

                // Правая панель: Карта
                rightPanel.innerHTML = '<h3>Карта вызовов</h3><div id="map"></div>';
                initMap(); // Инициализация после создания div

                // Нижняя панель: Логи
                logsPanel.innerHTML = '<h3>Лог процесса</h3><ul></ul>';
                const ul = logsPanel.querySelector('ul');
                logs.slice(-10).forEach(log => { // Последние 10
                    const li = document.createElement('li');
                    li.innerText = `${log.time}: ${log.message}`;
                    ul.appendChild(li);
                });

            } else if (currentUser.role === 'supervisor') {
                // Левая панель: Мониторинг операторов + Принятые вызовы
                leftPanel.innerHTML = '<h3>Мониторинг операторов</h3><table><tr><th>Имя</th><th>Статус</th><th>Вызовы</th></tr></table>';
                const table = leftPanel.querySelector('table');
                Object.keys(users).filter(u => users[u].role === 'operator').forEach(op => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${users[op].name}</td>
                        <td>${users[op].status}</td>
                        <td>${calls.filter(c => c.operator === users[op].name).length}</td>
                    `;
                    table.appendChild(row);
                });

                // Принятые вызовы
                leftPanel.innerHTML += '<h3>Принятые в работу вызовы</h3><div class="call-list"><table><tr><th>ID</th><th>Телефон</th><th>Адрес</th><th>Статус</th><th>Действия</th></tr></table></div>';
                const workTable = leftPanel.querySelectorAll('table')[1];
                calls.filter(c => c.status === 'в работе').forEach(call => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${call.id}</td>
                        <td>${call.phone}</td>
                        <td>${call.address}</td>
                        <td>${call.status}</td>
                        <td><button class="btn btn-accept" onclick="completeCall(${call.id})">Завершить</button></td>
                    `;
                    workTable.appendChild(row);
                });

                // Общая статистика для супервизора
                const stats = calculateStats();
                leftPanel.innerHTML += `<h3>Общая статистика</h3>
                    <p>Вызовов всего: ${stats.total}</p>
                    <p>Ложные: ${stats.false}</p>
                    <p>В работе: ${stats.inWork}</p>
                    <p>Среднее время ответа: ${stats.avgTime} сек</p>`;

                // Правая панель: Отчеты
                rightPanel.innerHTML = '<h3>Отчетность</h3><select id="report-period"><option>Сегодня</option><option>Вчера</option><option>Неделя</option><option>Месяц</option></select><button id="generate-report-btn">Сформировать</button><button id="export-report-btn">Экспорт</button><div id="report-preview"></div>';
                document.getElementById('generate-report-btn').addEventListener('click', generateReport);
                document.getElementById('export-report-btn').addEventListener('click', exportReport);

                // Логи в нижней панели для супервизора тоже
                logsPanel.innerHTML = '<h3>История действий</h3><ul></ul>';
                const ul = logsPanel.querySelector('ul');
                logs.forEach(log => {
                    const li = document.createElement('li');
                    li.innerText = `${log.time}: ${log.message}`;
                    ul.appendChild(li);
                });
            }

            // Обновление маркеров
            markers.forEach((marker, i) => updateMarkerColor(marker, calls[i] ? calls[i].status : ''));
        }

        // Инициализация карты
        function initMap() {
            ymaps.ready(() => {
                if (map) {
                    map.destroy(); // Если уже есть, уничтожить, чтобы пересоздать
                }
                map = new ymaps.Map('map', {
                    center: [55.7558, 37.6173],
                    zoom: 10
                });
                map.container.fitToViewport();
                console.log('Yandex Map initialized');
                // Пере добавить существующие маркеры
                map.geoObjects.removeAll();
                markers = [];
                calls.forEach(addMarker);
            }).catch(err => console.error('Yandex Map init error:', err));
        }

        // Принять вызов
        window.acceptCall = function(id) {
            const call = calls.find(c => c.id === id);
            if (call) {
                call.status = 'принят';
                call.operator = currentUser.name;
                currentUser.status = 'занят';
                addLog(`Принят вызов #${id} оператором ${currentUser.name}`);
                showCallModal(call);
                updateUI();
            }
        };

        // Отклонить вызов
        window.rejectCall = function(id) {
            const call = calls.find(c => c.id === id);
            if (call) {
                call.status = 'отклонен';
                addLog(`Отклонен вызов #${id}`);
                updateUI();
            }
        };

        // Завершить вызов (для супервизора)
        window.completeCall = function(id) {
            const call = calls.find(c => c.id === id);
            if (call) {
                call.status = 'завершен';
                addLog(`Завершен вызов #${id}`);
                updateUI();
            }
        };

        // Показать модал для вызова
        function showCallModal(call) {
            document.getElementById('call-info').innerText = `Вызов #${call.id} от ${call.phone}, адрес: ${call.address}`;
            document.getElementById('call-modal').style.display = 'flex';

            document.getElementById('start-call-btn').onclick = () => {
                call.status = 'в работе';
                addLog(`Начата работа с вызовом #${call.id}`);
                currentUser.status = 'занят';
                updateUI();
                closeModal();
            };

            document.getElementById('transfer-call-btn').onclick = () => {
                call.status = 'ожидание';
                call.operator = null;
                currentUser.status = 'свободен';
                addLog(`Переведен вызов #${call.id}`);
                updateUI();
                closeModal();
            };

            document.getElementById('false-call-btn').onclick = () => {
                call.status = 'ложный';
                currentUser.status = 'свободен';
                addLog(`Ложный вызов #${call.id}`);
                updateUI();
                closeModal();
            };

            document.getElementById('close-modal-btn').onclick = closeModal;
        }

        function closeModal() {
            document.getElementById('call-modal').style.display = 'none';
            if (currentUser.role === 'operator') currentUser.status = 'свободен';
            updateUI();
        }

        // Статистика
        function calculateStats() {
            const total = calls.length;
            const falseCalls = calls.filter(c => c.status === 'ложный').length;
            const inWork = calls.filter(c => c.status === 'в работе').length;
            const avgTime = calls.reduce((sum, c) => sum + (Date.now() - c.time) / 1000, 0) / (total || 1);
            return { total, false: falseCalls, inWork, avgTime: avgTime.toFixed(2) };
        }

        // Генерация отчета
        function generateReport() {
            const period = document.getElementById('report-period').value;
            // Симуляция: просто список вызовов
            let report = `Отчет за ${period}:\n`;
            calls.forEach(c => {
                report += `Вызов #${c.id}: ${c.phone}, ${c.address}, статус: ${c.status}\n`;
            });
            document.getElementById('report-preview').innerText = report;
        }

        // Экспорт отчета
        function exportReport() {
            const report = document.getElementById('report-preview').innerText;
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'report.txt';
            a.click();
        }
    </script>
</body>
</html>